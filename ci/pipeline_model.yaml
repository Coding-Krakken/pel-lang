# ============================================================================
# PEL CI/CD MODEL
# ============================================================================
# Purpose: Define continuous integration and delivery pipeline governance
# Date: 2026-02-13
# Version: 0.1.0
# Status: Canonical - workflows must conform to this model
# ============================================================================

metadata:
  model_version: "0.1.0"
  purpose: "Govern CI/CD pipeline for model-first governance enforcement"
  scope: "GitHub Actions workflows, quality gates, automation"

principles:
  - "Every commit MUST pass all quality gates"
  - "Tests MUST pass before merge"
  - "Coverage MUST be ≥ 80%"
  - "Linting and type checking MUST be clean"
  - "No manual quality checks - automate everything"
  - "Fast feedback - CI runs complete in < 5 minutes"
  - "Reproducible - same code produces same CI result"

workflows:
  test_workflow:
    name: "Test"
    file: ".github/workflows/test.yml"
    trigger:
      - "push to any branch"
      - "pull_request to main"
    jobs:
      test:
        runs_on: "ubuntu-latest"
        strategy:
          matrix:
            python_version: ["3.10", "3.11", "3.12"]
        steps:
          - name: "Checkout code"
            action: "actions/checkout@v3"
          - name: "Set up Python"
            action: "actions/setup-python@v4"
            with:
              python_version: "${{ matrix.python-version }}"
          - name: "Install dependencies"
            command: "pip install -e .[dev]"
          - name: "Lint with ruff"
            command: "ruff check ."
            fail_on_error: true
          - name: "Format check with black"
            command: "black --check ."
            fail_on_error: true
          - name: "Type check with mypy"
            command: "mypy compiler/ runtime/"
            fail_on_error: true
          - name: "Run tests"
            command: "pytest --cov=compiler --cov=runtime --cov-report=xml --cov-report=term"
            fail_on_error: true
          - name: "Check coverage"
            command: "pytest --cov-fail-under=80"
            fail_on_error: true
          - name: "Upload coverage"
            action: "codecov/codecov-action@v3"
            condition: "success()"
    quality_gates:
      - "All lint checks pass (ruff)"
      - "Code formatted correctly (black)"
      - "Type checking passes (mypy)"
      - "All tests pass (pytest)"
      - "Coverage ≥ 80%"
    failure_behavior:
      - "Block PR merge"
      - "Notify via GitHub status checks"
      - "Provide failure logs"

  pre_commit_workflow:
    name: "Pre-commit Checks"
    enforcement: "Local pre-commit hooks"
    file: ".pre-commit-config.yaml"
    hooks:
      - repo: "https://github.com/psf/black"
        hook: "black"
        purpose: "Format Python code"
      - repo: "https://github.com/astral-sh/ruff-pre-commit"
        hook: "ruff"
        purpose: "Lint Python code"
      - repo: "https://github.com/pre-commit/pre-commit-hooks"
        hooks:
          - "trailing-whitespace"
          - "end-of-file-fixer"
          - "check-yaml"
          - "check-added-large-files"
        purpose: "Basic file hygiene"
    installation_required: true
    command: "pre-commit install"

  release_workflow:
    name: "Release"
    file: ".github/workflows/release.yml"
    trigger:
      - "tag push matching v*.*.*"
    jobs:
      release:
        runs_on: "ubuntu-latest"
        steps:
          - name: "Checkout code"
            action: "actions/checkout@v3"
          - name: "Set up Python"
            action: "actions/setup-python@v4"
            with:
              python_version: "3.10"
          - name: "Install build tools"
            command: "pip install build twine"
          - name: "Build package"
            command: "python -m build"
          - name: "Check package"
            command: "twine check dist/*"
          - name: "Publish to PyPI"
            command: "twine upload dist/*"
            env:
              TWINE_USERNAME: "__token__"
              TWINE_PASSWORD: "${{ secrets.PYPI_TOKEN }}"
            condition: "github.ref startswith 'refs/tags/'"
    prerequisites:
      - "All tests passing on main"
      - "Version bumped in pyproject.toml"
      - "CHANGELOG.md updated"
      - "Tag created: git tag v0.1.0"
    status: "FUTURE (not implementing in initial conversion)"

quality_gates:
  gate_linting:
    name: "Code Linting"
    tool: "ruff"
    config_file: "pyproject.toml [tool.ruff]"
    failure_action: "Block merge"
  gate_formatting:
    name: "Code Formatting"
    tool: "black"
    config_file: "pyproject.toml [tool.black]"
    failure_action: "Block merge"
  gate_type_checking:
    name: "Static Type Checking"
    tool: "mypy"
    config_file: "pyproject.toml [tool.mypy]"
    scope: ["compiler/", "runtime/"]
    failure_action: "Block merge"
  gate_tests:
    name: "Test Suite"
    tool: "pytest"
    config_file: "pytest.ini"
    failure_action: "Block merge"
  gate_coverage:
    name: "Code Coverage"
    tool: "pytest-cov"
    threshold: 0.80
    scope: ["compiler/", "runtime/"]
    failure_action: "Block merge"

branch_protection:
  main_branch:
    branch: "main"
    rules:
      - "Require PR before merge: true"
      - "Require status checks: true"
      - "Require branches up to date: true"
      - "Restrict force push: true"
      - "Restrict deletions: true"
    merge_strategy: "squash"
