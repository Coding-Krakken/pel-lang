#!/usr/bin/env bash
# PEL pre-commit hook
# This hook runs automatic formatting and linting before commit
# To bypass: git commit --no-verify

set -e

# Colors for output  
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

echo -e "${YELLOW}Running PEL pre-commit checks...${NC}"

# Get list of staged .pel files
STAGED_PEL_FILES=$(git diff --cached --name-only --diff-filter=ACMR | grep '\.pel$' || true)

if [ -z "$STAGED_PEL_FILES" ]; then
    echo -e "${GREEN}✓ No .pel files to check${NC}"
    exit 0
fi

# Check if pel is installed
if ! command -v pel &> /dev/null && ! python -m pel_cli.main --version &> /dev/null; then
    echo -e "${RED}✗ PEL is not installed. Install with: pip install -e .${NC}"
    exit 1
fi

FAILED=0

# Format check
echo "Checking code formatting..."
for file in $STAGED_PEL_FILES; do
    if [ -f "$file" ]; then
        if ! python -m pel_cli.main format "$file" --check &> /dev/null; then
            echo -e "${YELLOW}  Formatting $file...${NC}"
            python -m pel_cli.main format "$file"
            git add "$file"
        fi
    fi
done

# Lint check (errors only)
echo "Running linter (errors only)..."
if ! python -m pel_cli.main lint $STAGED_PEL_FILES --severity error &> /dev/null; then
    echo -e "${RED}✗ Linter found errors:${NC}"
    python -m pel_cli.main lint $STAGED_PEL_FILES --severity error
    FAILED=1
else
    echo -e "${GREEN}✓ Linter passed${NC}"
fi

if [ $FAILED -eq 0 ]; then
    echo -e "${GREEN}✓ Pre-commit checks passed${NC}"
    exit 0
else
    echo -e "${RED}✗ Pre-commit checks failed${NC}"
    echo -e "${YELLOW}Fix the errors above or use 'git commit --no-verify' to bypass${NC}"
    exit 1
fi
